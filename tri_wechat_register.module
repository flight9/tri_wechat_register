<?php

//Import Wechat
require_once 'weichat.class.php';
require_once 'wechat_account.php';

header('Content-Type:text/html; charset=utf-8');

/**
 * Implements hook_menu
 */
function tri_wechat_register_menu() {
	$items = array();	
	$items['tri-wechat-register'] =  array(
		'title' => 'Register for Wechat',
		'page callback' => 'tri_wechat_register_page',
		'access arguments' => array('access content'), 
	);
	return $items;
}


/**
 * Implements hook_user_delete()
 */
function tri_wechat_register_user_delete($account) {
	#watchdog('tri_wechat_register', 'del user:'.$account->uid);
	$query = db_delete('wechat_login_user')
		->condition('uid', $account->uid)
		->execute();	
}

/**
 * Page callback
 */
function tri_wechat_register_page() {
	$wc_user = _get_wechat_user();
	
	$chk = _user_have_registered($wc_user);
	if($chk == 'not_registered') {
		//show register form
		return drupal_get_form('tri_wechat_register_form');
	}
	elseif( $chk == 'not_approved') {
		//TODO: show not_approved
		$content = t('You account has been registed and waiting to be approved.');
	} 
	elseif( $chk == 'denied') {
		//TODO: show not_approved
		$content = t('Sorry, you account registration has been denied.');
	} 
	else {	//'have_approved'
		//TODO: auto login
		$content = t('You account has been approved. Now we login automatically...');
	}
	
	return $content;
}

/**
 * help function
 */
function _get_wechat_user() {
	#krumo($_GET);
	//1. 授权回调网页域名 更新。
	//2. 菜单入口 更新，比如:
	//https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxa4ddad61df39d191&redirect_uri=http%3A%2F%2F6kaqbc.natappfree.cc%2Ftri-wechat-register&response_type=code&scope=snsapi_userinfo&state=0#wechat_redirect
	
	if(empty($_SESSION['wc_user'])) {
		$wc = new WeiChat(WECHAT_APPID, WECHAT_APPSECRET, WECHAT_TOKEN);
		$wc_user = $wc->getOAuth2UserInfo(false);
		$_SESSION['wc_user'] = $wc_user;
	} else {
		$wc_user = $_SESSION['wc_user'];
	}
	krumo($wc_user);
	
    return $wc_user;
}

/**
 * help funtion
 */
function _user_have_registered($wc_user) {
	//read wechat_login_user
	$query = db_select('wechat_login_user', 'w');
	$query->join('users', 'u', 'w.uid = u.uid');
	$result = $query->fields('w', array('openid'))
		->fields('u', array('uid', 'status'))
		->condition('openid', $wc_user->openid)
		->execute()->fetch();
	#krumo($result);
	
	if($result === FALSE) {
		return 'not_registered';
	} elseif( $result->status == 0) {
		return 'not_approved';
	} else {
		return 'have_approved';
	}
}


/**
 * Form create
 */
function tri_wechat_register_form($form, &$form_state) {
    $form['username'] = array(
            '#type' => 'textfield',
            '#title' => t('Username'),
            '#description' => t('Your username.'),
            '#required' => TRUE,
    );
    $form['password'] = array(
            '#type' => 'password_confirm',
            '#title' => t('Password'),
            '#description' => t('Your password.'),
            '#required' => TRUE,
    );
    $form['email'] = array(
            '#type' => 'textfield',
            '#title' => t('Email'),
            '#description' => t('Email address.'),
            '#required' => TRUE,
    );
    $form['mobile'] = array(
            '#type' => 'textfield',
            '#title' => t('Mobile'),
            '#description' => t('Mobile phoone number'),
            '#required' => TRUE,
    );
    //Submit
    $form['buttons']['submit'] = array(
            '#type' => 'submit',
            '#value' => t('Register'),
    );
	
    return $form;
}


/**
 * Form validate
 */
function tri_wechat_register_form_validate(&$form, &$form_state) {
    //Necessary validation
	//valid username
	if( $user_error = user_validate_name($form_state['values']['username'])) {
		form_set_error('username', $user_error);
	}
	
	//valid password?
	$re = '/^[a-z0-9_-]{6,18}$/i';
	if( preg_match($re, $form_state['values']['password']) == 0) {
		form_set_error('password', t('Please use a safer password.'));
	}
	
	//valid email
	if( valid_email_address($form_state['values']['email'])===false) {
		form_set_error('email', t('Please input a valid email address.'));
	}
	
	//valid mobile number
	$re = '/(^(13\d|15[^4,\D]|17[13678]|18\d)\d{8}|170[^346,\D]\d{7})$/i';
	if( preg_match($re, $form_state['values']['mobile']) == 0) {
		form_set_error('mobile', t('Please input a valid mobile number.'));
	}
}


/**
 * Form submit
 */
function tri_wechat_register_form_submit(&$form, &$form_state) {
    //create user
	$field_mobile =  array(
		'und' => array(
			0 => array(
				'value' => $form_state['values']['mobile'],
			),
		),
	);
	$fields = array(
		'name' => $form_state['values']['username'],
		'mail' => $form_state['values']['email'],
		'pass' => $form_state['values']['password'],
		'status' => 0,
		'field_mobile' => $field_mobile,
		'init' => $form_state['values']['email'],
		'roles' => array(
			4 => 'wechat authenticated',
		),
	);
	$account = user_save('', $fields);
	#krumo($account); exit;
    
    //save to wechat table(with openid)
	$wc_user = _get_wechat_user();
	_save_wechat_login_user($wc_user, $account->uid);
	
	//redirect
	$form_state['redirect'] = 'TODO';	//show not_approved OR no redirect?
}

/**
 * Help function
 */
function _save_wechat_login_user($wc_user, $uid) {
    $query = db_insert('wechat_login_user')
		->fields(array(
			'openid' => $wc_user->openid,
			'uid' => $uid,
			'user_link_type' => 0,
			'nickname' => $wc_user->nickname,
			'sex' => $wc_user->sex,
			'language' => $wc_user->language,
			'city' => $wc_user->city,
			'province' => $wc_user->province,
			'country' => $wc_user->country,
			'headimgurl' => $wc_user->headimgurl,
		))
		->execute();
}



