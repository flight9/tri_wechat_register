<?php

/**
 * Implements hook_menu
 */
function tri_wechat_register_menu() {
	$items = array();	
	$items['tri-wechat-register'] =  array(
		'title' => 'Wechat entrance',
		'page callback' => 'tri_wechat_register_page',
		'access arguments' => array('access content'), 
	);
	return $items;
}


/**
 * Page callback
 */
function tri_wechat_register_page() {
	$openid = _get_wechat_openid();
	if( $openid) {
		$_SESSION['openid'] = $openid;
	}
	
	$chk = _id_have_registered($openid);
	if($chk == 'not_registered') {
		//show register form
		return drupal_get_form('tri_wechat_register_form');
	}
	elseif( $chk == 'not_approved') {
		//TODO: show not_approved
		$content = 'not approved';
	} 
	else {	//'have_approved'
		//TODO: auto login
		$content = 'auto login ...';
	}
	
	return $content;
}

/**
 * help function
 */
function _get_wechat_openid() {
    return 'abcdefghijklmn1234567890';
}

/**
 * help funtion
 */
function _id_have_registered($openid) {
	//read wechat_login_user
	$query = db_select('wechat_login_user', 'w');
	$query->join('users', 'u', 'w.uid = u.uid');
	$result = $query->fields('w', array('openid'))
		->fields('u', array('uid', 'status'))
		->condition('openid', $openid)
		->execute()->fetch();
	#krumo($result);
	
	if($result === FALSE) {
		return 'not_registered';
	} elseif( $result->status == 0) {
		return 'not_approved';
	} else {
		return 'have_approved';
	}
}


/**
 * Form create
 */
function tri_wechat_register_form($form, &$form_state) {
    $form['username'] = array(
            '#type' => 'textfield',
            '#title' => t('Username'),
            '#description' => t('Your username.'),
            '#required' => TRUE,
    );
    $form['password'] = array(
            '#type' => 'password_confirm',
            '#title' => t('Password'),
            '#description' => t('Your password.'),
            '#required' => TRUE,
    );
    $form['email'] = array(
            '#type' => 'textfield',
            '#title' => t('Email'),
            '#description' => t('Email address.'),
            '#required' => TRUE,
    );
    $form['mobile'] = array(
            '#type' => 'textfield',
            '#title' => t('Mobile'),
            '#description' => t('Mobile phoone number'),
            '#required' => TRUE,
    );
    //Submit
    $form['buttons']['submit'] = array(
            '#type' => 'submit',
            '#value' => t('Register'),
    );
	
    return $form;
}


/**
 * Form validate
 */
function tri_wechat_register_form_validate(&$form, &$form_state) {
    //TODO: necessary validation
}


/**
 * Form submit
 */
function tri_wechat_register_form_submit(&$form, &$form_state) {
    //create user
	$field_mobile =  array(
		'und' => array(
			0 => array(
				'value' => $form_state['values']['mobile'],
			),
		),
	);
	$fields = array(
		'name' => $form_state['values']['username'],
		'mail' => $form_state['values']['email'],
		'pass' => $form_state['values']['password'],
		'status' => 0,
		'field_mobile' => $field_mobile,
		'init' => $form_state['values']['email'],
		'roles' => array(
			4 => 'wechat authenticated',
		),
	);
	$account = user_save('', $fields);
	#krumo($account); exit;
    
    //save to wechat table(with openid)
	$openid = $_SESSION['openid'];
	_save_wechat_login_user($openid, $account->uid);
	
	//redirect
	$form_state['redirect'] = 'TODO';	//show not_approved OR no redirect?
}

/**
 * Help function
 */
function _save_wechat_login_user($openid, $uid) {
    $query = db_insert('wechat_login_user')
		->fields(array('openid','uid'))
		->values(array(
			'openid' => $openid,
			'uid' => $uid,
		))
		->execute();
}



